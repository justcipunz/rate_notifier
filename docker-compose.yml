version: '3.8'

services:
  user_service:
    build: ./user_service 
    ports:
      - "8001:8000"
    volumes:
      - ./user_service/app:/code/app
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres_db:5432/${POSTGRES_DB}
      - SECRET_KEY=${USER_SERVICE_SECRET_KEY}
    depends_on:
      - postgres_db

  rate_tracker_service:
    build: ./rate_tracker_service
    volumes:
      - ./rate_tracker_service/app:/code/app
    environment:
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      - EXTERNAL_API_URL=https://www.cbr-xml-daily.ru/daily_json.js
      - FETCH_INTERVAL_SECONDS=60 
    depends_on:
      - rabbitmq

  notification_service:
    build: ./notification_service
    volumes:
      - ./notification_service/app:/code/app
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres_db:5432/${POSTGRES_DB}
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
    depends_on:
      - postgres_db
      - rabbitmq

  postgres_db:
    image: postgres:14-alpine
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data/

  rabbitmq:
    image: rabbitmq:3.9-management-alpine
    ports:
      - "15672:15672"
      - "5672:5672"
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}

volumes:
  postgres_data:
